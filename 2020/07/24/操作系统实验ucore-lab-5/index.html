<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>操作系统实验ucore-lab-5 | GRAIN</title><meta name="description" content="操作系统实验ucore-lab-5"><meta name="keywords" content="操作系统实验"><meta name="author" content="WhiteBeerHouse"><meta name="copyright" content="WhiteBeerHouse"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@v1.0.6/image/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="操作系统实验ucore-lab-5"><meta name="twitter:description" content="操作系统实验ucore-lab-5"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/background05.jpg"><meta property="og:type" content="article"><meta property="og:title" content="操作系统实验ucore-lab-5"><meta property="og:url" content="https://github.com/WhiteBeerHouse/WhiteBeerHouse.github.io/tree/master/2020/07/24/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8Cucore-lab-5/"><meta property="og:site_name" content="GRAIN"><meta property="og:description" content="操作系统实验ucore-lab-5"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/background05.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="https://github.com/WhiteBeerHouse/WhiteBeerHouse.github.io/tree/master/2020/07/24/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8Cucore-lab-5/"><link rel="next" title="数据库系统的知识集合" href="https://github.com/WhiteBeerHouse/WhiteBeerHouse.github.io/tree/master/2020/07/17/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%9F%A5%E8%AF%86%E9%9B%86%E5%90%88/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"Press","message_next":"to bookmark this page"},"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">43</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">24</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">5</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div></div></div></div><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#操作系统实验报告（实验六）"><span class="toc-number">1.</span> <span class="toc-text">操作系统实验报告（实验六）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#emsp-练习0"><span class="toc-number">1.0.0.1.</span> <span class="toc-text">&amp;emsp;练习0</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#emsp-练习1"><span class="toc-number">1.0.0.2.</span> <span class="toc-text">&amp;emsp;练习1</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#emsp-练习2"><span class="toc-number">1.0.0.3.</span> <span class="toc-text">&amp;emsp;练习2</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#emsp-练习3"><span class="toc-number">1.0.0.4.</span> <span class="toc-text">&amp;emsp;练习3</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/princess.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">GRAIN</a></span><span class="pull_right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">操作系统实验ucore-lab-5</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="Created 2020-07-24 12:55:06"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2020-07-24</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="Updated 2020-08-06 15:44:37"><i class="fa fa-history" aria-hidden="true"></i> Updated 2020-08-06</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>Word count:</span><span class="word-count">2.7k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>Reading time: 9 min</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h1 id="操作系统实验报告（实验六）"><a href="#操作系统实验报告（实验六）" class="headerlink" title="操作系统实验报告（实验六）"></a>操作系统实验报告（实验六）</h1><h4 id="emsp-练习0"><a href="#emsp-练习0" class="headerlink" title="&emsp;练习0"></a>&emsp;<strong>练习0</strong></h4><p>&emsp;&emsp;将 lab1、lab2、lab3、lab4 完成的代码移植到 lab5 中，涉及到的文件有：kern/debug/kdebug.c、kern/trap/trap.c、kern/mm/default_pmm.c、kern/mm/pmm.c、kern/mm/vmm.c、kern/mm/swap_fifo.c、kern/process/proc.c。<br>&emsp;&emsp;其中，需要对 kern/trap/trap.c、kern/process/proc.c 进行补充和修改。<br>&emsp;&emsp;kern/trap/trap.c：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">idt_init(<span class="keyword">void</span>) &#123;</span><br><span class="line">	<span class="keyword">extern</span> <span class="keyword">uintptr_t</span> __vectors[];</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; <span class="keyword">sizeof</span>(idt) / <span class="keyword">sizeof</span>(struct gatedesc))&#123;</span><br><span class="line">        SETGATE(idt[i], <span class="number">0</span>, GD_KTEXT, __vectors[i], DPL_KERNEL);</span><br><span class="line">        ++i;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//更新以下语句：</span></span><br><span class="line">	SETGATE(idt[T_SYSCALL], <span class="number">0</span>, GD_KTEXT, __vectors[T_SYSCALL], DPL_USER);<span class="comment">//设置特定中断号的中断门，使用户进程能够进行系统调用</span></span><br><span class="line">    lidt(&amp;idt_pd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>&emsp;&emsp;为使用户态进程能够进行系统调用以及从用户态切换到内核态，需要设置中断描述符 idt[T_SYSCALL]，其特权级设置为 DPL_USER，中断向量处理地址设置为 __vectors[T_SYSCALL] 处。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">trap_dispatch(struct trapframe *tf) &#123;</span><br><span class="line">    <span class="comment">/*...*/</span></span><br><span class="line">  		<span class="keyword">if</span> ((++ticks) % TICK_NUM == <span class="number">0</span>)&#123;</span><br><span class="line">			<span class="comment">//更新以下语句：</span></span><br><span class="line">			assert(current != <span class="literal">NULL</span>);<span class="comment">//检查当前进程是否合法</span></span><br><span class="line">			<span class="comment">//增加以下语句：</span></span><br><span class="line">			current-&gt;need_resched = <span class="number">1</span>;<span class="comment">//当分配给进程的时间片用完时将当前进程设置为需要被调度</span></span><br><span class="line">		&#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">	<span class="comment">/*...*/</span>    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>&emsp;&emsp;在中断时将当前进程设置为需要被调度的，以便在下一个时间片重新选择进程。<br/><br>&emsp;&emsp;kern/process/proc.c：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_struct</span> *</span></span><br><span class="line"><span class="class"><span class="title">alloc_proc</span>(<span class="title">void</span>) &#123;</span></span><br><span class="line">	<span class="comment">/*...*/</span></span><br><span class="line">		<span class="comment">//增加以下语句：</span></span><br><span class="line">		proc-&gt;wait_state = <span class="number">0</span>;<span class="comment">//设置进程为等待态</span></span><br><span class="line">		proc-&gt;cptr = <span class="literal">NULL</span>;<span class="comment">//设置进程的父进程为空</span></span><br><span class="line">		proc-&gt;yptr = <span class="literal">NULL</span>;<span class="comment">//设置进程的弟进程为空</span></span><br><span class="line">		proc-&gt;optr = <span class="literal">NULL</span>;<span class="comment">//设置进程的兄进程为空</span></span><br><span class="line">	<span class="comment">/*...*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>&emsp;&emsp;用户进程的进程控制块增加了进程等待状态和相关指针的条目，因此需要对应进行初始化。<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">do_fork(<span class="keyword">uint32_t</span> clone_flags, <span class="keyword">uintptr_t</span> <span class="built_in">stack</span>, struct trapframe *tf) &#123;</span><br><span class="line">	<span class="comment">/*...*/</span></span><br><span class="line">	proc-&gt;parent = current;</span><br><span class="line">	<span class="comment">//增加以下语句：</span></span><br><span class="line">	assert(proc-&gt;wait_state == <span class="number">0</span>);<span class="comment">//确保当前进程正在等待</span></span><br><span class="line">	<span class="comment">/*...*/</span></span><br><span class="line">	local_intr_save(intr_flag);</span><br><span class="line">    &#123;</span><br><span class="line">		proc-&gt;pid = get_pid();</span><br><span class="line">		hash_proc(proc);</span><br><span class="line">		<span class="comment">//删除以下语句：</span></span><br><span class="line">		<span class="comment">//++nr_process;</span></span><br><span class="line">		<span class="comment">//list_add(&amp;(proc_list), &amp;(proc-&gt;list_link));</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//增加以下语句：</span></span><br><span class="line">		set_links(proc);<span class="comment">//将新进程添加到进程列表中并设置相关连接</span></span><br><span class="line">	&#125;</span><br><span class="line">    local_intr_restore(intr_flag);</span><br><span class="line">	<span class="comment">/*...*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>&emsp;&emsp;需要注意的是 set_links 函数中已经实现了将进程添加到进程列表并使进程总数加 1，因此需要删减 lab4 对应的代码。<br><br/></p>
<h4 id="emsp-练习1"><a href="#emsp-练习1" class="headerlink" title="&emsp;练习1"></a>&emsp;<strong>练习1</strong></h4><ul>
<li><p>实现代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span></span><br><span class="line">load_icode(<span class="keyword">unsigned</span> <span class="keyword">char</span> *binary, <span class="keyword">size_t</span> <span class="built_in">size</span>) &#123;</span><br><span class="line">    <span class="comment">/* LAB5:EXERCISE1 YOUR CODE</span></span><br><span class="line"><span class="comment">     * should set tf_cs,tf_ds,tf_es,tf_ss,tf_esp,tf_eip,tf_eflags</span></span><br><span class="line"><span class="comment">	 ...</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">	tf-&gt;tf_cs = USER_CS;<span class="comment">//中断帧指向的代码段设为 USER_CS</span></span><br><span class="line">	tf-&gt;tf_ds = tf-&gt;tf_es = tf-&gt;tf_ss = USER_DS;<span class="comment">//中断帧指向的数据段和堆栈段等设为 USER_DS</span></span><br><span class="line">	tf-&gt;tf_esp = USTACKTOP;<span class="comment">//中断帧指向的 ESP 寄存器存放用户栈的栈顶</span></span><br><span class="line">	tf-&gt;tf_eip = elf-&gt;e_entry;<span class="comment">//中断帧指向的 EIP 寄存器存放 ELF 可执行文件加载到内存的入口</span></span><br><span class="line">	tf-&gt;tf_eflags = FL_IF;<span class="comment">//中断帧指向的 EFLAGS 寄存器存放中断使能的标志</span></span><br><span class="line">	<span class="comment">/*...*/</span></span><br></pre></td></tr></table></figure>
<p>为了使用户进程能够从内核态跳转到用户态，需要正确设置中断帧的段寄存器、ESP 寄存器、EIP 寄存器以及 EFLAGS 寄存器。根据提示填写代码，具体实现的理解已作注释。<br/> </p>
</li>
<li><p>描述当创建一个用户态进程并加载了应用程序后，CPU 是如何让这个应用程序最终在用户态执行起来的，即该用户态进程被 ucore 选择占用 CPU 执行（RUNNING 态）到具体执行应用程序第一条指令的整个经过。</p>
</li>
</ul>
<p>&emsp;&emsp;①. init_main 内核线程通过 user_main 函数调用 kernel_tread 创建用户进程，user_main 函数调用 kernel_execve 函数将具体应用程序的执行内容放入内存。<br>&emsp;&emsp;②. kernel_execve 函数执行 exec 系统调用，CPU 保存中断现场，根据中断号查找中断向量表，进入中断处理例程，之后进入 do_execve 函数。<br>&emsp;&emsp;③. do_execve 函数保证用户态虚拟内存空间合法后，回收旧进程的空间，调用 load_icode 函数。<br>&emsp;&emsp;④. load_icode 函数初始化新用户进程的内存空间，并修改中断帧，使中断返回时能够进入用户态并将控制权转移到应用程序入口处。<br>&emsp;&emsp;⑤. 通过 load_icode 函数完成用户进程的环境搭建后沿函数调用路径返回中断处理例程，待中断处理例程执行 iret 指令后完成特权级的转换，并跳转到应用程序的入口处，开始执行应用程序的的第一条指令。<br><br/></p>
<h4 id="emsp-练习2"><a href="#emsp-练习2" class="headerlink" title="&emsp;练习2"></a>&emsp;<strong>练习2</strong></h4><ul>
<li><p>补充 copy_range 的实现，确保能够正确执行。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">copy_range(<span class="keyword">pde_t</span> *to, <span class="keyword">pde_t</span> *from, <span class="keyword">uintptr_t</span> start, <span class="keyword">uintptr_t</span> <span class="built_in">end</span>, <span class="keyword">bool</span> share) &#123;</span><br><span class="line">    <span class="comment">/*...*/</span></span><br><span class="line">		<span class="keyword">void</span> *src_kvaddr = page2kva(page);<span class="comment">//获得父进程的物理页 page 对应的内核虚拟地址 src_kvaddr</span></span><br><span class="line">		<span class="keyword">void</span> *dst_kvaddr = page2kva(npage);<span class="comment">//获得子进程物理页 npage 对应的内核虚拟地址 dst_kvaddr</span></span><br><span class="line">		<span class="built_in">memcpy</span>(dst_kvaddr, src_kvaddr, PGSIZE);<span class="comment">//将父进程物理页的内容复制到子进程的物理页</span></span><br><span class="line">		<span class="comment">/* 以下语句参考答案之后已作修改 */</span></span><br><span class="line">		<span class="comment">//page_insert(to, npage, start, perm);</span></span><br><span class="line">		ret = page_insert(to, npage, start, perm);<span class="comment">//建立子进程的物理页与虚拟页的映射关系</span></span><br><span class="line">    <span class="comment">/*...*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>copy_range 函数用于将父进程的指定内存范围的虚拟页的内容复制到创建的子进程的物理页中，并为子进程的物理页和对应的虚拟页建立映射关系。根据提示填写代码，具体实现的理解已作注释。<br/></p>
</li>
<li><p>简要说明如何设计实现 “Copy on Write” 机制，给出概要设计，鼓励给出详细设计。</p>
</li>
</ul>
<p>&emsp;&emsp;“Copy on Write” 机制是指如果有多个使用者对一个资源 A 进行读操作，则每个使用者只需获得一个指向同一个资源 A 的指针就可以实现；若某使用者需要对该资源进行写操作，则系统会拷贝资源 A 到资源 B，使该使用者对其私有的资源 B 进行写操作。<br>&emsp;&emsp;因此可以在现有代码的基础上作如下修改来实现 “Copy on Write” 机制：<br>&emsp;&emsp;①. 在创建子进程时，复制内存部分暂不实际复制所有内存，而是使子进程的虚拟页指向父进程的可共享的物理页。<br>&emsp;&emsp;②. 取消父进程和子进程对共享页的写权限，使父进程或子进程试图对只读共享页执行写操作时会产生页访问异常，执行页异常处理，此时再复制需要进行写操作的页面，恢复进程对这部分页面的写权限。<br><br/></p>
<h4 id="emsp-练习3"><a href="#emsp-练习3" class="headerlink" title="&emsp;练习3"></a>&emsp;<strong>练习3</strong></h4><ul>
<li>对 fork/exec/wait/exit 函数的详细分析：</li>
</ul>
<p>&emsp;&emsp;①. fork 函数完成进程的拷贝工作。查看文件 /user/libs/ulib.c、/user/libs/syscall.c 和 /kern/process/proc.c 可知，fork 函数调用了 sys_fork 函数，sys_fork 函数执行系统调用 SYS_fork，该系统调用的实现由 do_fork 函数完成。<br>&emsp;&emsp;do_fork 函数的主要工作是：分配并初始化进程控制块-&gt;为子进程分配并初始化内核栈-&gt;复制原进程的内存管理信息到新进程-&gt;复制原进程上下文到新进程-&gt;为新进程分配进程号-&gt;将新进程添加到进程列表中-&gt;调用 wakeup_proc 函数将进程的状态设置为 PROC_RUNNABLE-&gt;将新进程的 id 作为返回码并返回。<br>&emsp;&emsp;②. exec 函数完成用户进程的创建及加载进程进入执行的工作。查看文件 /kern/process/proc.c 可知 kernel_execve 函数执行系统调用 SYS_exec，该系统调用的实现由 do_execve 函数完成。<br>&emsp;&emsp;do_execve 函数的主要工作是：保证用户态虚拟内存空间合法-&gt;调用 exit_mmap、put_pgdir 和 mm_destroy 函数清空当前进程内存空间的内存映射关系、页表信息和内存管理信息等-&gt;调用 load_icode 函数加载应用程序进入内存并建立新的内存映射关系-&gt;设置新加载的进程的名字然后返回。<br>&emsp;&emsp;③. wait 函数完成等待子进程结束以释放子进程占用的资源的工作。查看文件 /user/libs/ulib.c、/user/libs/syscall.c 和 /kern/process/proc.c 可知，wait 函数调用了 sys_wait 函数，sys_wait 函数执行系统调用 SYS_wait，该系统调用的实现由 do_wait 函数完成。<br>&emsp;&emsp;do_wait 函数的主要工作是：查找指定进程号或任意的一个状态为 PROC_ZOMBIE 的进程-&gt;如果找到则回收该进程，具体包括从进程队列中删除该进程、释放该进程的内核堆栈和进程控制块；如果找不到，则将当前进程状态修改为 PROC_SLEEPING，等待状态设置为 WT_CHILD 并调用 schedule 函数调度执行其他进程，直到其子进程结束唤醒该进程再重复寻找状态为 PROC_ZOMBIE 的进程。<br>&emsp;&emsp;④. exit 函数完成当前进程的退出和资源回收的工作。查看文件 /user/libs/ulib.c、/user/libs/syscall.c 和 /kern/process/proc.c 可知，exit 函数调用了 sys_exit 函数，sys_exit 函数执行系统调用 SYS_exit，该系统调用的实现由 do_exit 函数完成。<br>&emsp;&emsp;do_exit 函数的主要工作是：回收当前用户进程的大部分内存空间-&gt;将当前进程状态修改为 PROC_ZOMBIE，退出码设置为指定的 error_code-&gt;如果其父进程处于 WT_CHILD 的等待状态，则调用 wakeup_proc 函数唤醒其父进程完成当前进程的资源回收工作；如果当前进程有子进程，则将这些子进程设置为 initproc 的子进程，在有子进程处于 PROC_ZOMBIE 的情况下唤醒 initproc 完成这些子进程的资源回收工作-&gt;调用 schedule 函数调度新的进程执行。<br/></p>
<ul>
<li>对 fork/exec/wait/exit 函数在实现中如何影响进程的执行状态的分析：</li>
</ul>
<p>&emsp;&emsp;fork 函数创建子进程后将子进程的执行状态设置为 PROC_RUNNABLE，不改变父进程的执行状态。<br>&emsp;&emsp;exec 函数不改变进程的执行状态。<br>&emsp;&emsp;wait 函数在找到状态为 PROC_ZOMBIE 的进程的情况下回收该进程的资源，但不改变其他进程的执行状态；在找不到状态为 PROC_ZOMBIE 的进程的情况下会将当前进程的执行状态修改为 PROC_SLEEPING。<br>&emsp;&emsp;exit 函数将当前进程的执行状态修改为 PROC_ZOMBIE，唤醒父进程或 initproc，即将执行状态修改为 PROC_RUNNABLE。<br/></p>
<ul>
<li>ucore 中一个用户态进程的执行状态生命周期图：</li>
</ul>
<p><img width='120%px' height='120%' src='https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/lab5-010.png'/></p>
<p>&emsp;&emsp;在 lab5 目录下执行”make grade”，结果如下：<br>&emsp;&emsp;&emsp;&emsp;<img width='55%' height='55%' src='https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/lab5-001.png'/><br>&emsp;&emsp;实验顺利完成。<br/></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author:</span><span class="post-copyright-info"><a href="mailto:undefined">WhiteBeerHouse</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link:</span><span class="post-copyright-info"><a href="https://github.com/WhiteBeerHouse/WhiteBeerHouse.github.io/tree/master/2020/07/24/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8Cucore-lab-5/">https://github.com/WhiteBeerHouse/WhiteBeerHouse.github.io/tree/master/2020/07/24/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8Cucore-lab-5/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice:</span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8C/">操作系统实验</a></div><div class="post_share"></div></div><nav class="pagination_post" id="pagination"><div class="next-post pull-full"><a href="/2020/07/17/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%9F%A5%E8%AF%86%E9%9B%86%E5%90%88/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/Cover15.png" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@v1.0.6/image/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="next_info">数据库系统的知识集合</div></div></a></div></nav></article></main><footer id="footer" style="background-image: url(https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/princess.png)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;WhiteBeerHouse</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/js/search/local-search.js"></script></body></html>