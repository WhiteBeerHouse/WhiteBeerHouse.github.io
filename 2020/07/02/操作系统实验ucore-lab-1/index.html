<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>操作系统实验ucore-lab-1 | GRAIN</title><meta name="description" content="操作系统实验ucore-lab-1"><meta name="keywords" content="操作系统实验"><meta name="author" content="WhiteBeerHouse"><meta name="copyright" content="WhiteBeerHouse"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@v1.0.6/image/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="操作系统实验ucore-lab-1"><meta name="twitter:description" content="操作系统实验ucore-lab-1"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/background05.jpg"><meta property="og:type" content="article"><meta property="og:title" content="操作系统实验ucore-lab-1"><meta property="og:url" content="https://github.com/WhiteBeerHouse/WhiteBeerHouse.github.io/tree/master/2020/07/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8Cucore-lab-1/"><meta property="og:site_name" content="GRAIN"><meta property="og:description" content="操作系统实验ucore-lab-1"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/background05.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="https://github.com/WhiteBeerHouse/WhiteBeerHouse.github.io/tree/master/2020/07/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8Cucore-lab-1/"><link rel="prev" title="搜索" href="https://github.com/WhiteBeerHouse/WhiteBeerHouse.github.io/tree/master/2020/07/12/%E6%90%9C%E7%B4%A2/"><link rel="next" title="操作系统原理的知识集合" href="https://github.com/WhiteBeerHouse/WhiteBeerHouse.github.io/tree/master/2020/06/25/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"Press","message_next":"to bookmark this page"},"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.jpeg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">44</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">Tags</div><div class="length_num">26</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">6</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div></div></div></div><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#操作系统实验报告（实验二第一部分）"><span class="toc-number">1.</span> <span class="toc-text">操作系统实验报告（实验二第一部分）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#emsp-练习1"><span class="toc-number">1.0.0.1.</span> <span class="toc-text">&amp;emsp;练习1</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#emsp-练习2"><span class="toc-number">1.0.1.</span> <span class="toc-text">&amp;emsp;练习2</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/princess.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">GRAIN</a></span><span class="pull_right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">操作系统实验ucore-lab-1</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="Created 2020-07-02 20:06:43"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2020-07-02</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="Updated 2020-08-06 15:44:39"><i class="fa fa-history" aria-hidden="true"></i> Updated 2020-08-06</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>Word count:</span><span class="word-count">2.2k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>Reading time: 9 min</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h1 id="操作系统实验报告（实验二第一部分）"><a href="#操作系统实验报告（实验二第一部分）" class="headerlink" title="操作系统实验报告（实验二第一部分）"></a>操作系统实验报告（实验二第一部分）</h1><h4 id="emsp-练习1"><a href="#emsp-练习1" class="headerlink" title="&emsp;练习1"></a>&emsp;<strong>练习1</strong></h4><p>1.操作系统镜像文件ucore.img是如何一步一步生成的？(需要比较详细地解释Makefile中每一条相关命令和命令参数的含义，以及说明命令导致的结果)<br/></p>
<ul>
<li>Makefile 通过以下命令最终生成 ucore.img：</li>
</ul>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">UCOREIMG        := <span class="variable">$(<span class="built_in">call</span> totarget,ucore.img)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(UCOREIMG)</span>: <span class="variable">$(kernel)</span> <span class="variable">$(bootblock)</span></span><br><span class="line">        <span class="variable">$(V)</span>dd if=/dev/zero of=<span class="variable">$@</span> count=10000</span><br><span class="line">        <span class="variable">$(V)</span>dd if=<span class="variable">$(bootblock)</span> of=<span class="variable">$@</span> conv=notrunc</span><br><span class="line">        <span class="variable">$(V)</span>dd if=<span class="variable">$(kernel)</span> of=<span class="variable">$@</span> seek=1 conv=notrunc</span><br></pre></td></tr></table></figure>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UCOREIMG        := <span class="variable">$(<span class="built_in">call</span> totarget,ucore.img)</span></span><br></pre></td></tr></table></figure>
<p>表示如果变量 UCOREIMG 未定义，就把调用函数 totarget 的返回值赋值给变量 UCOREIMG。函数 totarget 定义在 tools/function.mk 中。<br/></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(UCOREIMG)</span>: <span class="variable">$(kernel)</span> <span class="variable">$(bootblock)</span></span><br></pre></td></tr></table></figure>
<p>表示 UCOREIMG 的生成依赖于 kernel 和 bootblock。<br/><br/></p>
<ul>
<li>生成 kernel 的主要命令：</li>
</ul>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kernel = <span class="variable">$(<span class="built_in">call</span> totarget,kernel)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(kernel)</span>: tools/kernel.ld</span><br><span class="line"></span><br><span class="line"><span class="variable">$(kernel)</span>: <span class="variable">$(KOBJS)</span></span><br><span class="line">	@echo + ld <span class="variable">$@</span></span><br><span class="line">	<span class="variable">$(V)</span><span class="variable">$(LD)</span> <span class="variable">$(LDFLAGS)</span> -T tools/kernel.ld -o <span class="variable">$@</span> <span class="variable">$(KOBJS)</span></span><br><span class="line">	@<span class="variable">$(OBJDUMP)</span> -S <span class="variable">$@</span> &gt; <span class="variable">$(<span class="built_in">call</span> asmfile,kernel)</span></span><br><span class="line">	@<span class="variable">$(OBJDUMP)</span> -t <span class="variable">$@</span> | <span class="variable">$(SED)</span> '1,/SYMBOL TABLE/d; s/ .* / /; /^$$/d' &gt; <span class="variable">$(<span class="built_in">call</span> symfile,kernel)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kernel = <span class="variable">$(<span class="built_in">call</span> totarget,kernel)</span></span><br></pre></td></tr></table></figure>
<p>指定 kernel 存放的目录。<br/></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(kernel)</span>: tools/kernel.ld</span><br></pre></td></tr></table></figure>
<p>表示生成 kernel 依赖于 tools/kernel.ld。<br/></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(kernel)</span>: <span class="variable">$(KOBJS)</span></span><br><span class="line">	@echo + ld <span class="variable">$@</span></span><br><span class="line">	<span class="variable">$(V)</span><span class="variable">$(LD)</span> <span class="variable">$(LDFLAGS)</span> -T tools/kernel.ld -o <span class="variable">$@</span> <span class="variable">$(KOBJS)</span></span><br><span class="line">	@<span class="variable">$(OBJDUMP)</span> -S <span class="variable">$@</span> &gt; <span class="variable">$(<span class="built_in">call</span> asmfile,kernel)</span></span><br><span class="line">	@<span class="variable">$(OBJDUMP)</span> -t <span class="variable">$@</span> | <span class="variable">$(SED)</span> '1,/SYMBOL TABLE/d; s/ .* / /; /^$$/d' &gt; <span class="variable">$(<span class="built_in">call</span> symfile,kernel)</span></span><br></pre></td></tr></table></figure>
<p>表示生成 kernel 依赖于一些 .o 文件，具体文件通过在终端执行 make “V=” 命令查看。-T 表示使链接器使用指定脚本，此处指定脚本为 tools/kernel.ld。-o 指定了输出文件为变量 kernel, KOBJS 所引用的对象。使用 objdump 反汇编得到 kernel 的汇编代码，-S 表示将反汇编得到的汇编代码与源代码混合并最终保存在 kernel.asm 中。-t 表示打印文件的符号表表项，通过管道将带有符号表的反汇编结果作为 sed 命令的标准输入进行处理，最终将符号表信息保存到 kernel.sym 中。<br/></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ld -m elf_i386 -nostdlib -T tools/kernel.ld -o bin/kernel obj/kern/init/init.o obj/kern/libs/readline.o obj/kern/libs/stdio.o obj/kern/debug/kdebug.o obj/kern/debug/kmonitor.o obj/kern/debug/panic.o obj/kern/driver/clock.o obj/kern/driver/console.o obj/kern/driver/intr.o obj/kern/driver/picirq.o obj/kern/trap/trap.o obj/kern/trap/trapentry.o obj/kern/trap/vectors.o obj/kern/mm/pmm.o obj/libs/printfmt.o obj/libs/string.o</span><br></pre></td></tr></table></figure>
<p>以上通过在终端执行 make “V=” 得到的部分已执行命令展示了 kernel 的生成，所依赖的 .o 文件有 init.o, readline.o, stdio.o, kdebug.o, kmonitor.o, panic.o, clock.o, console.o, intr.o, picirq.o, trap.o, trapentry.o, vectors.o, pmm.o, printfmt.o, string.o。<br/><br>其中，命令</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">call</span> add_files_cc,$(<span class="built_in">call</span> listf_cc,<span class="variable">$(LIBDIR)</span>)</span>,libs,)</span><br></pre></td></tr></table></figure>
<p>指定生成的 libs 目录下包含的CTYPE文件（.c文件和.S文件）所对应的 .o 文件以及 .d 文件的存放（相关函数定义在 tools/function.mk 中）。<br/><br>命令</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">call</span> add_files_cc,$(<span class="built_in">call</span> listf_cc,<span class="variable">$(KSRCDIR)</span>)</span>,kernel,<span class="variable">$(KCFLAGS)</span>)</span><br></pre></td></tr></table></figure>
<p>指定生成的 kern 所有子目录下包含的CTYPE文件（.c 文件和 .S 文件）所对应的 .o 文件以及 .d 文件的存放（相关函数定义在 tools/function.mk 中）。<br/></p>
<p>以生成 libs/printfmt.o 为例，经层层参数传递调用函数最终执行的命令为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Ilibs/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc -fno-stack-protector -Ilibs/ -c libs/printfmt.c -o obj/libs/printfmt.o</span><br></pre></td></tr></table></figure>
<p>表示 libs/printfmt.o 由 libs/printfmt.c 生成。<br/><br/></p>
<ul>
<li>生成 bootblock 的主要命令：</li>
</ul>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bootblock = <span class="variable">$(<span class="built_in">call</span> totarget,bootblock)</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(bootblock)</span>: <span class="variable">$(<span class="built_in">call</span> toobj,<span class="variable">$(bootfiles)</span>)</span> | <span class="variable">$(<span class="built_in">call</span> totarget,sign)</span></span><br><span class="line">	@echo + ld <span class="variable">$@</span></span><br><span class="line">	<span class="variable">$(V)</span><span class="variable">$(LD)</span> <span class="variable">$(LDFLAGS)</span> -N -e start -Ttext 0x7C00 <span class="variable">$^</span> -o <span class="variable">$(<span class="built_in">call</span> toobj,bootblock)</span></span><br><span class="line">	@<span class="variable">$(OBJDUMP)</span> -S <span class="variable">$(<span class="built_in">call</span> objfile,bootblock)</span> &gt; <span class="variable">$(<span class="built_in">call</span> asmfile,bootblock)</span></span><br><span class="line">	@<span class="variable">$(OBJCOPY)</span> -S -O binary <span class="variable">$(<span class="built_in">call</span> objfile,bootblock)</span> <span class="variable">$(<span class="built_in">call</span> outfile,bootblock)</span></span><br><span class="line">	@<span class="variable">$(<span class="built_in">call</span> totarget,sign)</span> <span class="variable">$(<span class="built_in">call</span> outfile,bootblock)</span> <span class="variable">$(bootblock)</span></span><br></pre></td></tr></table></figure>
<p>bootblock 的生成依赖于一些 .o 文件和 sign。其中，这些 .o 文件由 bootfiles 引用的对象生成。bootfiles 由命令</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bootfiles = <span class="variable">$(<span class="built_in">call</span> listf_cc,boot)</span></span><br><span class="line"><span class="variable">$(<span class="built_in">foreach</span> f,<span class="variable">$(bootfiles)</span>,$(<span class="built_in">call</span> cc_compile,<span class="variable">$(f)</span>,<span class="variable">$(CC)</span>,<span class="variable">$(CFLAGS)</span> -Os -nostdinc)</span>)</span><br></pre></td></tr></table></figure>
<p>定义。上述命令表示由 boot 目录下包含的CTYPE文件（bootmain.c 和 bootasm.s）生成所对应的 .o 文件（bootmain.o 和 bootasm.o）。<br/></p>
<p>经层层参数传递调用函数最终执行的命令为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Iboot/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc -fno-stack-protector -Ilibs/ -Os -nostdinc -c boot/bootmain.c -o obj/boot/bootmain.o</span><br></pre></td></tr></table></figure>
<p>表示 obj/boot/bootmain.o 由 boot/bootmain.c 生成；<br/></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -Iboot/ -fno-builtin -Wall -ggdb -m32 -gstabs -nostdinc -fno-stack-protector -Ilibs/ -Os -nostdinc -c boot/bootasm.S -o obj/boot/bootasm.o</span><br></pre></td></tr></table></figure>
<p>表示obj/boot/bootasm.o 由 boot/bootasm.S 生成。<br/><br>其中，指定的 gcc 参数含义如下：</p>
<ul>
<li>-Iboot: 增加 boot/ 为搜索头文件的路径；</li>
<li>-fno-builtin: 不接受不是两个下划线开头的内建函数；</li>
<li>-Wall: 使 gcc 生成尽可能多的警告信息；</li>
<li>-ggdb: 以本地格式（如果支持）输出调试信息，尽可能包括 gdb 扩展，以便供 gdb 调试；</li>
<li>-m32: 生成能在32位机器上运行的代码；</li>
<li>-gstabs: 以stabs格式(如果支持)输出调试信息；</li>
<li>-nostdinc: 不搜索标准系统头文件；</li>
<li>-fno-stack-protector: 禁用栈溢出保护；</li>
<li>-Os: 启用所有不增加代码大小的 -O2 优化；</li>
</ul>
<p>sign 由命令</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(<span class="built_in">call</span> add_files_host,tools/sign.c,sign,sign)</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> create_target_host,sign,sign)</span></span><br></pre></td></tr></table></figure>
<p>定义。经层层参数传递调用函数最终执行的命令为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -Itools/ -g -Wall -O2 -c tools/sign.c -o obj/sign/tools/sign.o </span><br><span class="line">gcc -g -Wall -O2 obj/sign/tools/sign.o -o bin/sign</span><br></pre></td></tr></table></figure>
<p>表示 bin/sign 由 obj/sign/tools/sign.o 优化编译生成，obj/sign/tools/sign.o 由 tools/sign.c 生成。<br/><br>其中，指定的 gcc 参数含义如下：</p>
<ul>
<li>-Itools: 增加 tools/ 为搜索头文件的路径；</li>
<li>-g: 以操作系统的本地格式产生调试信息，供 gdb 使用；</li>
<li>-Wall: 使 gcc 生成尽可能多的警告信息；</li>
<li>-O2: 启用 O2 优化，执行除了时间和空间交换的几乎所有优化工作；</li>
</ul>
<p>接下来生成bootblock:</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bootblock = <span class="variable">$(<span class="built_in">call</span> totarget,bootblock)</span></span><br></pre></td></tr></table></figure>
<p>指定 bootblock 存放的目录。<br/></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(bootblock)</span>: <span class="variable">$(<span class="built_in">call</span> toobj,<span class="variable">$(bootfiles)</span>)</span> | <span class="variable">$(<span class="built_in">call</span> totarget,sign)</span></span><br><span class="line">	@echo + ld <span class="variable">$@</span></span><br><span class="line">	<span class="variable">$(V)</span><span class="variable">$(LD)</span> <span class="variable">$(LDFLAGS)</span> -N -e start -Ttext 0x7C00 <span class="variable">$^</span> -o <span class="variable">$(<span class="built_in">call</span> toobj,bootblock)</span></span><br></pre></td></tr></table></figure>
<p>表示生成 bootblock 依赖于bootmain.o, bootasm.o, sign。-N 表示将代码段和数据段设置为可读可写；-e 设置程序入口；-Ttext 设置代码段的起始地址；-o 指定了输出文件为 obj/bootblock.o。<br/><br/></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ld -m elf_i386 -nostdlib -N -e start -Ttext 0x7C00 obj/boot/bootasm.o obj/boot/bootmain.o -o obj/bootblock.o</span><br></pre></td></tr></table></figure>
<p>生成 bootblock.o 的实际执行命令如上。<br/></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="variable">$(OBJDUMP)</span> -S <span class="variable">$(<span class="built_in">call</span> objfile,bootblock)</span> &gt; <span class="variable">$(<span class="built_in">call</span> asmfile,bootblock)</span></span><br></pre></td></tr></table></figure>
<p>表示使用 objdump 反汇编得到 bootblock.o 的汇编代码，-S 表示将得到的汇编代码保存在 bootblock.asm 中。<br/></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="variable">$(OBJCOPY)</span> -S -O binary <span class="variable">$(<span class="built_in">call</span> objfile,bootblock)</span> <span class="variable">$(<span class="built_in">call</span> outfile,bootblock)</span></span><br></pre></td></tr></table></figure>
<p>表示使用 objcopy 将 bootblock.o 二进制拷贝到 bootblock.out。<br/><br>其中，-S 表示不从源文件中复制重定位信息和符号信息；-O binary 表示指定的输出格式为二进制。<br/></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="variable">$(<span class="built_in">call</span> totarget,sign)</span> <span class="variable">$(<span class="built_in">call</span> outfile,bootblock)</span> <span class="variable">$(bootblock)</span></span><br></pre></td></tr></table></figure>
<p>表示使用 sign 工具用 bootblock.out 生成 bootblock。<br/><br/></p>
<ul>
<li>依赖文件 kernel 和 bootblock 已存在，生成 ucore.img：</li>
</ul>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(V)</span>dd if=/dev/zero of=<span class="variable">$@</span> count=10000</span><br></pre></td></tr></table></figure>
<p>从 /dev/zero 获取大小为10000个块的文件空间，每个块默认大小为512字节，且均为空字符，输出到目标文件 bin/ucore.img。<br/></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(V)</span>dd if=<span class="variable">$(bootblock)</span> of=<span class="variable">$@</span> conv=notrunc</span><br></pre></td></tr></table></figure>
<p>将 bootblock 中的数据写到 bin/ucore.img 第一个块。conv=notrunuc 表示不截断输出文件。<br/></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$(V)</span>dd if=<span class="variable">$(kernel)</span> of=<span class="variable">$@</span> seek=1 conv=notrunc</span><br></pre></td></tr></table></figure>
<p>将 kernel 中的数据写到 bin/ucore.img 第二个块。seek=1 表示跳过 bin/ucore.img 的第一个块。<br/><br>至此，ucore.img 生成。<br/></p>
<p>2.一个被系统认为是符合规范的硬盘主引导扇区的特征是什么？<br/></p>
<ul>
<li>一个硬盘主引导扇区占据一个扇区，大小为 512 个字节。</li>
<li>该扇区最后两个字节分别为 0x55 和 0xAA。</li>
</ul>
<p><br/></p>
<h3 id="emsp-练习2"><a href="#emsp-练习2" class="headerlink" title="&emsp;练习2"></a>&emsp;<strong>练习2</strong></h3><p>1.从 CPU 加电后执行的第一条指令开始，单步跟踪 BIOS 的执行。</p>
<ul>
<li>将 lab1/tools/gdbinit 文件内容修改为:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set architecture i8086</span><br><span class="line">target remote: 1234</span><br></pre></td></tr></table></figure>
<ul>
<li>在 lab1 目录下执行：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make debug</span><br></pre></td></tr></table></figure>
<ul>
<li>进入 gdb 调试页面：</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/lab1-001.png"  alt=""></p>
<ul>
<li>使用命令 layout regs 查看 CS:EIP 可知 CPU 加电后执行的第一条指令地址为 0xffff0，使用命令 x /i 0xffff0 查看对应汇编代码：</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/lab1-002.png"  alt=""></p>
<ul>
<li>使用命令 si 单步跟踪：</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/lab1-003.png"  alt=""></p>
<p>&emsp;&emsp;&emsp;可知第一条指令已经执行，后续单步跟踪与上述步骤一致。<br/><br/></p>
<p>2.在初始化位置 0x7c00 设置实地址断点，测试断点正常。</p>
<ul>
<li>在 lab1/tools/gdbinit 文件内容后面加上:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">b *0x7c00</span><br><span class="line">continue</span><br></pre></td></tr></table></figure>
<ul>
<li>在 lab1 目录下执行 make debug 后进入 gdb 调试页面：</li>
</ul>
<p><img src="/" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/lab1-004.png"  alt=""></p>
<p>&emsp;&emsp;&emsp;显示断点 1 在地址 0x7c00 处，查看 CS:EIP 可知当前指令指向地址 0x7c00 处，可知断点正常。<br/></p>
<p>3.在调用 qemu 时增加-d in_asm -D q.log 参数，便可以将运行的汇编指令保存在 q.log 中。从 0x7c00 开始跟踪代码运行,将单步跟踪反汇编得到的代码与 bootasm.S 和 bootblock.asm 进行比较，看看二者是否一致。</p>
<ul>
<li><p>修改 Makefile 文件：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">debug: <span class="variable">$(UCOREIMG)</span></span></span><br><span class="line">	<span class="variable">$(V)</span><span class="variable">$(TERMINAL)</span> -e <span class="string">"<span class="variable">$(QEMU)</span> -S -s -d in_asm -D <span class="variable">$(BINDIR)</span>/q.log -parallel stdio -hda <span class="variable">$&lt;</span> -serial null"</span> </span><br><span class="line">	<span class="variable">$(V)</span>sleep 2</span><br><span class="line">	<span class="variable">$(V)</span><span class="variable">$(TERMINAL)</span> -e <span class="string">"gdb -q -tui -x tools/gdbinit"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 lab1 目录下执行 make debug 后再查看 q.log 文件：</p>
</li>
</ul>
<p>&emsp;&emsp;&emsp;<img src="/" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/lab1-010.png"  alt=""> </p>
<p>&emsp;&emsp;&emsp;<img src="/" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/lab1-011.png"  alt=""> </p>
<p>&emsp;&emsp;&emsp;<img src="/" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/lab1-012.png"  alt=""> </p>
<p>&emsp;&emsp;&emsp;<img src="/" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/lab1-013.png"  alt=""> </p>
<p>&emsp;&emsp;&emsp;<img src="/" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/lab1-014.png"  alt=""> </p>
<p>&emsp;&emsp;&emsp;<img src="/" class="lazyload" data-src="https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/lab1-015.png"  alt=""> </p>
<p>&emsp;&emsp;&emsp;与 bootasm.S 和 bootblock.asm 比较可知一致。<br/></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author:</span><span class="post-copyright-info"><a href="mailto:undefined">WhiteBeerHouse</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link:</span><span class="post-copyright-info"><a href="https://github.com/WhiteBeerHouse/WhiteBeerHouse.github.io/tree/master/2020/07/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8Cucore-lab-1/">https://github.com/WhiteBeerHouse/WhiteBeerHouse.github.io/tree/master/2020/07/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8Cucore-lab-1/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice:</span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%9E%E9%AA%8C/">操作系统实验</a></div><div class="post_share"></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/07/12/%E6%90%9C%E7%B4%A2/"><img class="prev_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/Cover10.png" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@v1.0.6/image/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="prev_info">搜索</div></div></a></div><div class="next-post pull_right"><a href="/2020/06/25/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%89%A9%E5%B1%95%E7%9F%A5%E8%AF%86/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/background05.jpg" onerror="onerror=null;src='https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@v1.0.6/image/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="next_info">操作系统原理的知识集合</div></div></a></div></nav></article></main><footer id="footer" style="background-image: url(https://cdn.jsdelivr.net/gh/sherryjw/StaticResource@latest/image/princess.png)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;WhiteBeerHouse</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/js/search/local-search.js"></script></body></html>